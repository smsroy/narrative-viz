<!DOCTYPE html>
<html lang="en-us">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <head>
    <meta charset="UTF-8" />
    <title>Narrative-viz by smsroy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/normalize.css"
      media="screen"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:200,500"
      rel="stylesheet"
      type="text/css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/stylesheet.css"
      media="screen"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/github-light.css"
      media="screen"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="stylesheets/custom.css"
      media="screen"
    />
  </head>

  <body onload="init()">
    <section class="page-header1">
      <h1 class="project-name">Jobs Visualization</h1>
    </section>
    <div class="w3-bar w3-teal">
      <a
        href="#"
        onclick="navigate('previous');"
        class="w3-bar-item w3-button"
        style="width: 27%;"
        ><<</a
      >
      <a
        href="#"
        onclick="navigate('summary');"
        class="w3-bar-item w3-button"
        style="width: 15%;"
        >Summary</a
      >
      <a
        href="#"
        onclick="navigate('jobsby');"
        class="w3-bar-item w3-button"
        style="width: 15%;"
        >Jobs By</a
      >
      <a
        href="#"
        onclick="navigate('jobsdetail');"
        class="w3-bar-item w3-button w3-green"
        style="width: 15%;"
        >Jobs Details</a
      >
      <a
        href="#"
        onclick="navigate('next');"
        class="w3-bar-item w3-button"
        style="width: 28%;"
        >>></a
      >
    </div>
    <section class="main-content">
      <h3>
        <span aria-hidden="true" class="octicon octicon-link"></span>Jobs Details
        by Company, Salary Estimate, Rating, Location
      </h3>
      </p>
      <div id="selectchoice">
        <div id="selectdiv"></div>
        <div id="bydiv"></div>
      </div>
      <div>
        <div></br></div>
        <div> 
          <label id="chartlabel" for="chartlabel"></label>
        </div>
        <svg width="600" height="600"></svg>
        Select Value: 
        <select id="byval"></select>
        
        <input type="checkbox" id="sort">	
        Toggle sort         
      </div>

      <footer class="site-footer">
        <span class="site-footer-owner"
          ><a href="https://github.com/smsroy/narrative-viz">Narrative-viz</a>
          is maintained by <a href="https://github.com/smsroy">smsroy</a>.</span
        >

        <span class="site-footer-credits"
          >This page was generated by
          <a href="https://pages.github.com">GitHub Pages</a> using the
          <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a>
          by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span
        >
      </footer>
    </section>

    <script>
      //Global Variable
      var data; // this one holds csv data
      var filteredData = []; // holds filtered data per parameters
      var chartdata = []; //this will hold chart data at any point of time
      var totaljobs;
      var topjobs = []; // Top job Keys
      var origin;
      var originby = 'Company Name';  //default
      var originByVal;
      var margin = {
        top: 50,
        right: 50,
        bottom: 50,
        left: 50,
      };
      var width = 650;
      var height = 400;
      var xwidth = width - 2 * margin.right - 2 * margin.left;
      var yheight = height - 2 * margin.top - 2 * margin.bottom;
      const addfactor = 10;

      var currentPage = "chart3.html";
      var nextPage = "chart3.html";
      var previousPage = "chart2.html";
      var summaryPage = "chart1.html";
      var jobsbyPage = "chart2.html";
      var jobsdetailPage = "chart3.html";

      function navigate(action) {
        if (action == "next") {
          dest = nextPage;
        } else if (action == "previous") {
          dest = previousPage;
        } else if (action == "summary") {
          dest = summaryPage;
        } else if (action == "jobsby") {
          dest = jobsbyPage;
        } else if (action == "jobsdetail") {
          dest = jobsdetailPage;
        } else dest = "#";
        window.location = dest;
      }      

      //Function to do array value sum
      Array.prototype.sum = function (prop) {
        var total = 0;
        for (var i = 0, _len = this.length; i < _len; i++) {
          total += this[i][prop];
        }
        return total;
      }

      // Function to check if key exists in array
      function keyExists(keyval) {
        return topjobs.some(function(el) {
        return el === keyval;
      }); 
}      

      //Function to Load jobs list
      function loadJobs() {
        var seldata = d3
          .nest()
          .key(function (d) {
            return d.JobTitle == "" ? "None" : d.JobTitle;
          })
          .rollup(function (d) {
            return d3.sum(d, function (g) {
              return 1;
            });
          })
          .entries(data);

        totaljobs = seldata.sum("value"); // getting total jobs

        seldata.sort(function (a, b) {
          return d3.descending(+a.value, +b.value);
        });
        var jobdata = seldata.slice(0, 20); // Top 20 elements
        topjobs = jobdata.map(d => {return d.key;}); //Storing top job titles
        // console.log('topjobs', topjobs);

        // Commented section to add other jobs and number
        var remjobdata = seldata.slice(20); // remaining after 20 elements
        // console.log(remjobdata.sum("value"));
        const newElement = [{ key: "Others", value: remjobdata.sum("value") }];
        jobdata = jobdata.concat(newElement); // added others as the first element
        // console.log(jobdata);

        //Now load data to the select
        // ***** adding jobs select ******
        var jobtitlelabel = document.createElement("label");
        jobtitlelabel.innerHTML =
          "Select Job : ";
        jobtitlelabel.htmlFor = "jobs";

        var selectjobtitle = document.createElement("select");
        selectjobtitle.name = "jobtitle";
        selectjobtitle.id = "jobtitle";
        selectjobtitle.addEventListener("change", function (event) {
          origin = document.getElementById("jobtitle").value;
          initializeChartData();
          showChart();
        });

        //add one first option - All
        var jobtitleoption = document.createElement("option");
        jobtitleoption.value = "All Jobs";
        jobtitleoption.text = "All Jobs : " + totaljobs;
        selectjobtitle.appendChild(jobtitleoption);

        for (const val of jobdata) {
          jobtitleoption = document.createElement("option");
          jobtitleoption.value = val.key;
          jobtitleoption.text = val.key + " : " + val.value;
          if (val.key == origin) jobtitleoption.selected = true;
          selectjobtitle.appendChild(jobtitleoption);
        }

        //First remove all elements and then add
        document.getElementById("selectdiv").innerHTML = null;
        document
          .getElementById("selectdiv")
          .appendChild(jobtitlelabel)
          .appendChild(selectjobtitle);
      }

      //Not required
      // function loadPage(id) {
      //   dest = "chart3.html" + "?origin=" + id;
      //   //console.log(dest);
      //   window.location = dest;
      // }

      //Function called on body onload
      async function init() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        origin =
          urlParams.get("origin") == undefined ||
          urlParams.get("origin") == null ||
          urlParams.get("origin") == ""
            ? "All Jobs"
            : urlParams.get("origin");
        originby =
          urlParams.get("originby") == undefined ||
          urlParams.get("originby") == null ||
          urlParams.get("originby") == ""
            ? "Company Name"
            : urlParams.get("originby");
        originbyval =
          urlParams.get("originbyval") == undefined ||
          urlParams.get("originbyval") == null ||
          urlParams.get("originbyval") == ""
            ? "any"
            : urlParams.get("originbyval");            
        console.log('origin', origin);
        console.log('originby', originby);
        console.log('originbyval', originbyval);

        data = await d3.csv("data/DataEngineer2.csv");

        //Load Job select
        loadJobs();
        initializeChartData();
        //Show chart
        showChart();
      }

      //Function to form chart data depending on selection
      function initializeChartData() {
        var keyval;

        // first filter data by origin type
        if (originby === 'Type of Ownership') {
          if (originbyval === '') {
            filteredData = data.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = data.filter(function(d){
              if ((d.TypeOfOwnership == '-1') || (d.TypeOfOwnership.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
          } else {
            filteredData = data.filter(function(d){return d.TypeOfOwnership == originbyval;});
          }
        } 
        else if (originby === 'Industry') {
          if (originbyval === '') {
            filteredData = data.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = data.filter(function(d){
              if ((d.Industry == '-1') || (d.Industry.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
          } else {
            filteredData = data.filter(function(d){return d.Industry == originbyval;});
          }
        }
        else if (originby === 'Sector') {
          if (originbyval === '') {
            filteredData = data.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = data.filter(function(d){
              if ((d.Sector == '-1') || (d.Sector.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
          } else {
            filteredData = data.filter(function(d){return d.Sector == originbyval;});
          }
        }
        else if (originby === 'Company Revenue') {
          if (originbyval === '') {
            filteredData = data.filter(function(d){return d;});
          } else if (originbyval === 'Unknown') {
            filteredData = data.filter(function(d){
              if ((d.Revenue == '-1') || (d.Revenue.toLowerCase().indexOf('unknown') !== -1)) 
              return d ;
            });
          } else {
            filteredData = data.filter(function(d){return d.Revenue == originbyval;});
          }
        } 
        //console.log('filteredData', filteredData);

        // form chart data now
        var interimData, interimData1 = [];
        interimData = d3
        .nest()
        .key(function (d) {
          if (d["CompanyName"] === "") keyval = "NA";
          else if (d["CompanyName"] === "-1") keyval = "NA";
          else keyval = d["CompanyName"].split('\n')[0]; //Removing linefeed and numbers at the end of company name
          // console.log('keyval', keyval);
          if (origin === "All Jobs") return keyval;
          else if (origin === "Others") {
            if (keyExists(d.JobTitle)) return "Filter";
            else return keyval;
          }           
          else if (d.JobTitle === origin) return keyval;
          else return "Filter";
        })      
        .rollup(function (d) {
          return {
            data_engineer: d3.sum(d, function (g) {
              if (g.JobTitle.toLowerCase() == 'data engineer') return 1;
              else return 0;
            }),
            senior_data_engineer: d3.sum(d, function (g) {
              if (g.JobTitle.toLowerCase() == 'senior data engineer') return 1;
              else return 0;
            }),
            software_engineer: d3.sum(d, function (g) {
              if (g.JobTitle.toLowerCase() == 'software engineer') return 1;
              else return 0;
            }),
            bigdata_engineer: d3.sum(d, function (g) {
              if (g.JobTitle.toLowerCase() == 'big data engineer') return 1;
              else return 0;
            }),
            others: d3.sum(d, function (g) {
              if ((g.JobTitle.toLowerCase() != 'data engineer') &&
              (g.JobTitle.toLowerCase() != 'senior data engineer') &&
              (g.JobTitle.toLowerCase() != 'software engineer') &&
              (g.JobTitle.toLowerCase() != 'big data engineer')) {
                return 1;
              }
              else return 0;
            }),
            total: d3.sum(d, function (g) {
                return 1;
            })                                                                
          }
        })
        .entries(filteredData);

        interimData1 = interimData.slice().sort((a, b) => d3.descending(a.value.total, b.value.total));
        chartdata = interimData1.map(function (obj) {
          return {
            byval : originbyval,
            key: obj.key,
            data_engineer: obj.value.data_engineer,
            senior_data_engineer: obj.value.senior_data_engineer,
            software_engineer: obj.value.software_engineer,
            bigdata_engineer: obj.value.bigdata_engineer,
            others: obj.value.others,
            total: obj.value.total            
          }
        });
      }

      //Function to draw chart
      function showChart() {
        console.log('chartdata', chartdata);            
      }

    </script>
  </body>
</html>
